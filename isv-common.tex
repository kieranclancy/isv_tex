\scrollmode

% Allow enough space for the page numbers in the TOC.
% tocrmarg should be about 1em greater than pnumwidth
\makeatletter
\renewcommand{\@pnumwidth}{3em}
\renewcommand{\@tocrmarg}{4em}
\makeatother

\renewcommand*\sfdefault{uop} % Optima for sans font

% page style
\makepagestyle{headvref}
\makepagestyle{bookstart}
\makeevenhead{headvref}{\rightmark}{\booktab}{The Holy Bible}
\makeoddhead{headvref}{International Standard Version 2.0}{\booktab}{\leftmark}
\makeevenfoot{headvref}{}{\thepage}{}
\makeoddfoot{headvref}{}{\thepage}{}
\makeoddhead{bookstart}{\def\thepageref{}}{\booktab}{}
\makeevenhead{bookstart}{\def\thepageref{}}{\booktab}{}
\makeevenfoot{bookstart}{}{\thepage}{}
\makeoddfoot{bookstart}{}{\thepage}{}
\pagestyle{headvref}

% Stop footnotes overrunning the end of the page
% 64 is default. 71 is apparently normally enough, but proved not to
% be for us (Matthew chapter 4 was overrunning by two lines)
%\renewcommand*{\footfudgefiddle}{80}

% Uncomment this if marginal crossreferences occassionally end up in
% the wrong margin
\strictpagecheck

% block-side tabs
\newcounter{booktabposition}
\newcommand{\resetbooktab}{\setcounter{booktabposition}{0}}
\newcommand{\preresetbooktab}{\setcounter{booktabposition}{0}}
\newcommand{\advancebooktab}{%
  \addtocounter{booktabposition}{1}
  \ifthenelse{\equal{\value{booktabposition}}{5}}{\setcounter{booktabposition}{0}}
}
\newcommand{\considerbooktab}{\ifthenelse{\equal{\thebook}{}}{}{\booktab}}
\newcommand{\booktab}{%
  \ifthenelse{\equal{\thebook}{}}{}{
    \edef\y{\value{booktabposition}}
    \strictpagechecktrue
    \checkoddpage
    \edef\xl{\ifoddpage{\booktabevenxoffset - \booktabwidth}\else{0}\fi}
    \edef\xr{\ifoddpage{\booktabevenxoffset}\else{\booktabwidth}\fi}
    \ifoddpage{%
      \begin{tikzpicture}[remember picture,overlay]
        \node[yshift=0in] at (current page.north west)
        {\begin{tikzpicture}[remember picture, overlay]
            \path [fill=Gray] (\xl,\booktabyoffset - \y * \booktabheight) rectangle
            (\xr,\booktabyoffset - \y * \booktabheight - 1 * \booktabheight) {};
            \node[anchor=east,xshift=\booktabevenxoffset -0.5 * \booktabwidth + 0.5 *
            \booktabfontsize + \booktaboddxfudge,
            yshift=\booktabyoffset - \y * \booktabheight - 0.5 * \booktabheight,rectangle]
            {\rotatebox{270}{\color{white}\fontsize{\booktabfontsize}{\booktabfontsize}\fontseries{b}\selectfont\MakeUppercase{\thebook}}};
          \end{tikzpicture}
        };
      \end{tikzpicture}
    }\else{%
      \begin{tikzpicture}[remember picture,overlay]
        \node[yshift=0in] at (current page.north west)
        {\begin{tikzpicture}[remember picture, overlay]
            \path [fill=Gray] (\xl,\booktabyoffset - \y * \booktabheight) rectangle
            (\xr,\booktabyoffset - \y * \booktabheight - 1 * \booktabheight) {};
            \node[anchor=east,xshift=0.5 * \booktabwidth + 0.5 *
            \booktabfontsize  + \booktabevenxfudge,
            yshift=\booktabyoffset - \y * \booktabheight - 0.5 * \booktabheight,rectangle]
            {\rotatebox{90}{\color{white}\fontsize{\booktabfontsize}{\booktabfontsize}\fontseries{b}\selectfont\MakeUppercase{\thebook}}};
          \end{tikzpicture}
        };
      \end{tikzpicture}
    }\fi
  }
}

% paragraph spacing
\setlength{\vgap}{1em}
\setlength{\vindent}{3\vgap}
\setlength{\stanzaskip}{0\baselineskip}
\setbeforesubsubsecskip{-1ex plus -.8ex minus -.2ex}
\setaftersubsubsecskip{0.7ex plus .2ex}
\setlength{\emergencystretch}{3em}
\setlength{\parindent}{0.8\parindent}

% Avoid widows and orphans (see
% http://en.wikibooks.org/wiki/LaTeX/Page_Layout#Widows_and_orphans
% for more suggestions if this doesn't work well enough)
% See also
% http://tex.stackexchange.com/questions/21983/how-to-avoid-page-breaks-inside-paragraphs
% The formulation here makes widowing after a single line REALLY
% expensive.  This ensures we don't have any dropcaps/lettrines that
% go past the end of the page.
\widowpenalties 2 10000 300
\clubpenalty=300

% footnote style
\paragraphfootnotes

\renewcommand*{\thefootnote}{\textbf{\textrm{\alphalph{\value{footnote}}}}}
%\setlength{\footmarkwidth}{1em}
%\footmarkstyle{#1\hfill}
\setlength{\footmarkwidth}{0em}
%\footmarkstyle{{\scriptsize#1}\hspace{0.4em}}%\textsuperscript{#1}}
% Push superscript references for footnotes down a bit, to keep line
% height under control, thus avoiding irregular line spacing, and
% improving the overall appearance.
\footmarkstyle{\raisebox{-0.1\baselineskip}{\textsuperscript{#1}}}
\renewcommand{\foottextfont}{\renewcommand{\v}{\footv}\fontfamily{ptm}\footnotesize}
\MakePerPage{footnote}

% Here we force the footnote rule and text color to black to address a bug
% where \paragraphfootnotes erroneously uses the colour of the last
% paragraph if it spans the page break.  This results in some pages
% having red footnotes.

% Make the horizontal rule for foot notes black regardless of the
% colour of the preceeding text.
% As below it makes the following footnote text black as well. 
\makeatletter
\renewcommand{\footnoterule}{%
  \color{black}%
  \kern-3\p@
  \hrule width .4\columnwidth
  \kern 2.6\p@}
\makeatother
% If the following is used instead, only the rule becomes black, and
% the text remains mixed colour, but with the red/black bugs affecting
% things, so it probably cannot be used at this time.
%\makeatletter
%\renewcommand{\footnoterule}{%
%  {\color{black}%
%  \kern-3\p@
%  \hrule width .4\columnwidth
%  \kern 2.6\p@}}}
%\makeatother

% This increases the incentive to break footnote lines prior to the footnote starting
\makeatletter
\let\old@parafootfmt\@parafootfmt
\def\@parafootfmt#1{\old@parafootfmt{#1}\relax\penalty -1000}
\makeatother

% formatting
\newcommand{\bookheader}[1]{\newpage\thispagestyle{bookstart}\advancebooktab\def\thebook{#1}}
\newcommand{\labelbook}[1]{\def\theshortbook{#1}\def\thechapter{}\def\theverse{}\def\theref{}}
\newcommand{\bookpretitle}[1]{{\centering \large \textsc{#1} \par}\addvspace{-0.6em plus 0.2em}}
\newcommand{\booktitle}[1]{%
  {\centering \Huge \textsc{\textbf{#1}}\par}\addvspace{0.4em plus 0.1em}%
  \addcontentsline{toc}{section}{#1}%
}
\newlength{\hangvwidth}
\newcommand{\verseone}{}
%\marginparmargin{outer}
\marginparmargin{inner}
\let\oldmarginpar\marginpar
\renewcommand\marginpar[2][]{%
  \oldmarginpar{\mpjustification #2}}
\renewcommand{\v}[1]{\edef\prevref{\theref}%
   \def\theverse{#1}%
   \ifthenelse{\equal{\thechapter}{}}%
   {\edef\theref{\thebook{ }\theverse}}{%
   \edef\theref{\thebook{ }{\thechapter:}\theverse}}%
   \markboth{\theref}{\theref}%
   \ifthenelse{\equal{\getcrossref{\theshortbook}{\thechapter}{\theverse}}{}}{}{\marginpar{\tiny\textbf{\ifthenelse{\equal{\thechapter}{}}{}{\thechapter:}\theverse} \getcrossref{\theshortbook}{\thechapter}{\theverse}}}%
   \ifthenelse{\equal{#1}{1}}{\verseone}{\textsuperscript{#1}}}
\makeatletter
\let\old@v\v
\newcommand{\vpoem}[1]{\settowidth{\hangvwidth}{\old@v{#1}}\setlength{\hangvwidth}{0.75\hangvwidth}\ifhmode\kern\hangvwidth\vadjust{}\else\leavevmode\fi\kern-\hangvwidth\old@v{#1}\nobreak\hskip\z@skip}
\makeatother
\newcommand{\footv}[1]{\textsuperscript{#1}}
\newcommand{\fnote}[1]{\footnote{#1}}
\newcommand{\fbib}[1]{\textit{#1}}
\newcommand{\fbackref}[1]{{\scriptsize{#1}}}
%\newcommand{\poempassage}[1]{\subsubsection{\hspace{-4em}\textsf{#1}}~\\\vspace{-1.2\baselineskip}}
\newcommand{\passage}[1]{\par\addvspace{1.0em}\noindent\textbf{{\textbf{\fontfamily{uop}#1}}}\par\nopagebreak\addvspace{0.0em plus 0.2em minus 0.0em}}
\newcommand{\poempassage}[1]{\par\addvspace{0.1em plus 0.6em}\noindent\hspace{-4em}\textbf{\textsf{#1}}\par\nopagebreak\addvspace{0.0em plus 0.2em minus 0.0em}}
\newcommand*{\ensuretwolinepar}{%
    \let\origpar\par
    \def\par{%
        \origpar
        \let\par\origpar
        \ifnum\prevgraf<2 %
            \addvspace{0.6\baselineskip}
        \fi
    }%
}
\newcommand{\chapt}[1]{\needspace{2\baselineskip}% Make sure there
                                % are two lines to fit the lettrine
                                % (XXX doesn't seem to actually work)
\lettrine[lraise=0.00,loversize=0.07]{#1}{}\ensuretwolinepar}
\newcommand{\labelchapt}[1]{\def\thechapter{#1}}
\newcommand{\poeml}{\penalty50\relax}
\newcommand{\poemll}{\penalty150\vin}
\newcommand{\poemlll}{\penalty150\vin\vin}
\newcommand{\divine}[1]{\textsc{#1}}
\newcommand{\passageinfo}[1]{\vspace{-0.3\baselineskip}\subsubsection*{\hspace{0em}\textmd{\textsf{\textit{#1}}}}}
\newcommand{\itemb}[1]{%
    \renewcommand{\footnote}{\bulletfootnote}%
    \item[#1] \bulletfoottext{}%
    \renewcommand{\footnote}{\oldfootnote}%
}
\newcommand{\heb}[1]{\textcjheb{#1}}
\newcommand{\footfract}[2]{\nicefrac{#1}{#2}}
\renewcommand{\textonehalf}{\nicefrac{1}{2}}
\newcommand{\booksection}[1]{{\vspace{\baselineskip}\centering \large \textsc{\textbf{#1}}\par\vspace{\baselineskip}}}
\newcommand{\labelpsalm}[1]{\def\thechapter{#1}\labelchapt{#1}{\centering \textbf{Psalm~#1} \par}}
\newcommand{\psalminfo}[1]{{\small \textmd{\textsf{\textit{#1}}}\par\relax}}
\newcommand{\interlude}[1]{\hfill\textit{#1}\par\relax}

\makeatletter
\newenvironment{poetry}{%
    \renewcommand{\passage}{\poempassage}%
    \renewcommand{\v}{\vpoem}%
    \vspace{-0.7\topsep}%
    \addtolength{\vleftmargin}{0.5em}%
% interfered with quotes
%    \activatepunct%
    \begin{verse}%
}{%
    \end{verse}%
    \vspace{-0.7\topsep}%
    \penalty-100\relax% small bonus for page breaking here
}
\makeatother

\newenvironment{bulletlist}{%
    \gdef\bulletfoottext{}%
    \let\oldfootnote\footnote%
    \providecommand{\bulletfootnote}[1]%
        {\footnotemark \gdef\bulletfoottext{\footnotetext{##1}\gdef\bulletfoottext{}}}%
    \begin{enumerate}%
}{%
    \end{enumerate}%
}

\hyphenation{Naph-tuhites}
\hyphenation{quar-reled}
\hyphenation{when-ever}
\hyphenation{Eph-raim}

% Cross-references
\newcommand{\crossref}[4]{\csdef{xref#1x#2x#3}{#4}}
\newcommand{\getcrossref}[3]{\csuse{xref#1x#2x#3}}
\input{crossrefs}

\begin{document}

\setcounter{tocdepth}{3}
\tableofcontents*
\newpage
